#!/usr/bin/env ruby
# frozen_string_literal: true

gemfile = ENV["BUNDLE_GEMFILE"] || "Gemfile"

unless File.exist?(gemfile)
  warn "#{gemfile} not found"
  exec "bundle", *ARGV
end

lockfile = "#{gemfile}.lock"
if File.exist?(lockfile)
  content = File.read(lockfile)
else
  warn "Locking #{lockfile}"
  content = `bundle lock 2>&1`
  exec "bundle", *ARGV if $?.success?
end

require 'matching_bundle'
# require_relative '../lib/matching_bundle' # use this for local debugging
if version = MatchingBundle.find_or_install_matching_version(content)
  puts "VER #{version}"
  exec "bundle", "_#{version}_", *ARGV
else
  exec "bundle", *ARGV
end
